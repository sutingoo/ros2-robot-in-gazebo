<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="mi_robot_autonomo">

    <xacro:property name="radio_rueda" value="0.05"/>
    <xacro:property name="longitud_rueda" value="0.04"/>
    <xacro:property name="largo_chasis" value="0.4"/>
    <xacro:property name="ancho_chasis" value="0.3"/>
    <xacro:property name="alto_chasis" value="0.1"/>
    
    <xacro:property name="masa_chasis" value="1.0"/> 
    <xacro:property name="masa_rueda" value="0.2"/>

    <xacro:macro name="inercia_caja" params="masa x y z">
        <inertial>
            <mass value="${masa}"/>
            <inertia ixx="${(1/12) * masa * (y*y + z*z)}" ixy="0.0" ixz="0.0"
                     iyy="${(1/12) * masa * (x*x + z*z)}" iyz="0.0"
                     izz="${(1/12) * masa * (x*x + y*y)}"/>
        </inertial>
    </xacro:macro>

    <xacro:macro name="inercia_cilindro" params="masa r h">
        <inertial>
            <mass value="${masa}"/>
            <inertia ixx="${(1/12) * masa * (3*r*r + h*h)}" ixy="0" ixz="0"
                     iyy="${(1/12) * masa * (3*r*r + h*h)}" iyz="0"
                     izz="${(1/2) * masa * (r*r)}"/>
        </inertial>
    </xacro:macro>

    <link name="base_footprint"/>

    <joint name="base_joint" type="fixed">
        <parent link="base_footprint"/>
        <child link="base_link"/>
        <origin xyz="0 0 ${radio_rueda}" rpy="0 0 0"/>
    </joint>

    <link name="base_link">
        <visual>
            <geometry>
                <box size="${largo_chasis} ${ancho_chasis} ${alto_chasis}"/>
            </geometry>
            <material name="azul">
                <color rgba="0.1 0.1 1 1"/> </material>
        </visual>
        
        <collision>
            <geometry>
                <box size="${largo_chasis} ${ancho_chasis} ${alto_chasis}"/>
            </geometry>
        </collision>
        
        <xacro:inercia_caja masa="${masa_chasis}" x="${largo_chasis}" y="${ancho_chasis}" z="${alto_chasis}"/>
    </link>

    <xacro:macro name="rueda" params="prefijo x_pos y_pos">
        <link name="${prefijo}_rueda">
            <visual>
                <geometry>
                    <cylinder radius="${radio_rueda}" length="${longitud_rueda}"/>
                </geometry>
                <material name="negro">
                    <color rgba="0 0 0 1"/>
                </material>
            </visual>
            
            <collision>
                <geometry>
                    <cylinder radius="${radio_rueda}" length="${longitud_rueda}"/>
                </geometry>
            </collision>

            <xacro:inercia_cilindro masa="${masa_rueda}" r="${radio_rueda}" h="${longitud_rueda}"/>
        </link>

        <joint name="${prefijo}_joint" type="continuous">
            <parent link="base_link"/>
            <child link="${prefijo}_rueda"/>
            <origin xyz="${x_pos} ${y_pos} 0" rpy="-1.5708 0 0"/> 
            <axis xyz="0 0 1"/> 
        </joint>
    </xacro:macro>

    <xacro:property name="wheel_offset_x" value="0.15"/>
    <xacro:property name="wheel_offset_y" value="0.17"/>

    <xacro:rueda prefijo="front_left"  x_pos="${wheel_offset_x}"  y_pos="${wheel_offset_y}"/>
    <xacro:rueda prefijo="front_right" x_pos="${wheel_offset_x}"  y_pos="-${wheel_offset_y}"/>
    <xacro:rueda prefijo="rear_left"   x_pos="-${wheel_offset_x}" y_pos="${wheel_offset_y}"/>
    <xacro:rueda prefijo="rear_right"  x_pos="-${wheel_offset_x}" y_pos="-${wheel_offset_y}"/>
<gazebo>
    <plugin name="diff_drive" filename="libgazebo_ros_diff_drive.so">
        <left_joint>front_left_joint</left_joint>
        <right_joint>front_right_joint</right_joint>

        <wheel_separation>0.35</wheel_separation>
        <wheel_diameter>0.1</wheel_diameter>

        <max_wheel_torque>200</max_wheel_torque>
        <max_wheel_acceleration>10.0</max_wheel_acceleration>

        <odometry_frame>odom</odometry_frame>
        <robot_base_frame>base_footprint</robot_base_frame>

        <publish_odom>true</publish_odom>
        <publish_odom_tf>true</publish_odom_tf>
        <publish_wheel_tf>true</publish_wheel_tf>
    </plugin>
</gazebo>
<gazebo reference="lidar_link">
        <sensor name="lidar" type="ray">
            <pose>0 0 0 0 0 0</pose>
            <visualize>true</visualize> <update_rate>10</update_rate>
            <ray>
                <scan>
                    <horizontal>
                        <samples>360</samples> <resolution>1</resolution>
                        <min_angle>-3.14</min_angle> <max_angle>3.14</max_angle>  </horizontal>
                </scan>
                <range>
                    <min>0.3</min>
                    <max>12</max> </range>
            </ray>
            <plugin name="laser_controller" filename="libgazebo_ros_ray_sensor.so">
                <ros>
                    <argument>~/out:=scan</argument>
                </ros>
                <output_type>sensor_msgs/LaserScan</output_type>
                <frame_name>lidar_link</frame_name>
            </plugin>
        </sensor>
    </gazebo>
<gazebo reference="camera_link">
        <sensor type="camera" name="camera_sensor">
            <update_rate>30.0</update_rate> <camera name="head">
                <horizontal_fov>1.3962634</horizontal_fov> <image>
                    <width>800</width>
                    <height>800</height>
                    <format>R8G8B8</format>
                </image>
                <clip>
                    <near>0.02</near>
                    <far>300</far>
                </clip>
            </camera>
            <plugin name="camera_controller" filename="libgazebo_ros_camera.so">
                <alwaysOn>true</alwaysOn>
                <updateRate>0.0</updateRate>
                <cameraName>camera</cameraName>
                <imageTopicName>image_raw</imageTopicName>
                <cameraInfoTopicName>camera_info</cameraInfoTopicName>
                <frameName>camera_link</frameName>
                <hackBaseline>0.07</hackBaseline>
            </plugin>
        </sensor>
    </gazebo>
<link name="lidar_link">
        <visual>
            <geometry>
                <cylinder radius="0.05" length="0.04"/>
            </geometry>
            <material name="rojo">
                <color rgba="1 0 0 1"/>
            </material>
        </visual>
        <collision>
            <geometry>
                <cylinder radius="0.05" length="0.04"/>
            </geometry>
        </collision>
        <xacro:inercia_cilindro masa="0.1" r="0.05" h="0.04"/>
    </link>

    <joint name="lidar_joint" type="fixed">
        <parent link="base_link"/>
        <child link="lidar_link"/>
        <origin xyz="0 0 ${alto_chasis + 0.02}" rpy="0 0 0"/>
    </joint>
<link name="camera_link">
        <visual>
            <geometry>
                <box size="0.02 0.08 0.02"/> </geometry>
            <material name="rojo"/>
        </visual>
        <collision>
            <geometry>
                <box size="0.02 0.08 0.02"/>
            </geometry>
        </collision>
        <xacro:inercia_caja masa="0.05" x="0.02" y="0.08" z="0.02"/>
    </link>

    <joint name="camera_joint" type="fixed">
        <parent link="base_link"/>
        <child link="camera_link"/>
        <origin xyz="${largo_chasis/2} 0 ${alto_chasis/2 + 0.01}" rpy="0 0 0"/>
    </joint>
 <gazebo reference="rear_left_rueda">
    <mu1>0.01</mu1>
    <mu2>0.01</mu2>
</gazebo>

<gazebo reference="rear_right_rueda">
    <mu1>0.01</mu1>
    <mu2>0.01</mu2>
</gazebo>
</robot>
